generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id
  name          String
  email         String       @unique
  emailVerified Boolean
  image         String?
  role          String       @default("user")
  createdAt     DateTime
  updatedAt     DateTime
  accounts      Account[]
  invitations   Invitation[]
  members       Member[]
  sessions      Session[]

  @@map("user")
}

model Session {
  id                   String   @id
  expiresAt            DateTime
  token                String   @unique
  createdAt            DateTime
  updatedAt            DateTime
  ipAddress            String?
  userAgent            String?
  userId               String
  activeOrganizationId String?
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Organization {
  id               String       @id
  name             String
  slug             String?      @unique
  logo             String?
  createdAt        DateTime
  metadata         String?
  theme            String?
  plan             String       @default("free")
  polarCustomerId  String?      @unique // Polar customer ID for billing
  billingInterval  String?      // "monthly" or "annual"
  projects         Project[]
  invitations      Invitation[]
  members          Member[]
  apiTokens        ApiToken[]

  @@index([plan])
  @@index([polarCustomerId])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  userId         String
  role           String
  createdAt      DateTime
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Project {
  id               String            @id @default(cuid())
  name             String
  domain           String?           @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  organizationId   String?
  eventDefinitions EventDefinition[]
  organization     Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiTokenProjects ApiTokenProject[]
  funnels          Funnel[]
  extensions       ProjectExtension[]

  @@index([organizationId])
}


model EventDefinition {
  id                String                   @id @default(cuid())
  name              String
  description       String?
  trackingId        String
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  projectId         String
  project           Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectExtensions ProjectExtensionEvent[]

  @@unique([projectId, trackingId])
  @@unique([projectId, name])
  @@index([projectId])
}



model NotificationPreference {
  id                String   @id @default(cuid())
  userId            String
  projectId         String
  liveVisitorToasts Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("notification_preference")
}

model ApiToken {
  id             String            @id @default(cuid())
  name           String
  description    String?
  tokenHash      String            @unique
  tokenPrefix    String
  organizationId String
  allowedDomains String[]          @default([])
  createdAt      DateTime          @default(now())
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects       ApiTokenProject[]

  @@index([tokenHash])
  @@index([organizationId])
  @@map("api_token")
}

model ApiTokenProject {
  id        String   @id @default(cuid())
  tokenId   String
  projectId String
  token     ApiToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([tokenId, projectId])
  @@index([tokenId])
  @@index([projectId])
  @@map("api_token_project")
}

model ApiHealthCheck {
  id            String   @id @default(cuid())
  endpoint      String
  statusCode    Int
  responseTimeMs Int
  isHealthy     Boolean
  errorMessage  String?
  timestamp     DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([endpoint])
  @@index([timestamp])
  @@index([isHealthy])
  @@index([endpoint, timestamp])
  @@unique([endpoint, timestamp])
  @@map("api_health_check")
}

model ApiHealthAlertState {
  id                  String    @id @default(cuid())
  endpoint            String    @unique
  consecutiveFailures Int       @default(0)
  isInAlertState      Boolean   @default(false)
  lastAlertSentAt     DateTime?
  updatedAt           DateTime  @updatedAt
  createdAt           DateTime  @default(now())

  @@index([endpoint])
  @@index([isInAlertState])
  @@map("api_health_alert_state")
}

model Funnel {
  id          String       @id @default(cuid())
  name        String
  description String?
  projectId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  endDate     DateTime?
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  steps       FunnelStep[]

  @@index([projectId])
  @@index([createdAt])
  @@map("funnel")
}

model FunnelStep {
  id         String   @id @default(cuid())
  funnelId   String
  type       String
  name       String
  url        String?
  eventName  String?
  eventCode  String?
  positionX  Float
  positionY  Float
  stepOrder  Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  funnel     Funnel   @relation(fields: [funnelId], references: [id], onDelete: Cascade)

  @@index([funnelId])
  @@index([funnelId, stepOrder])
  @@map("funnel_step")
}

model ProjectExtension {
  id               String                   @id @default(cuid())
  projectId        String
  extensionId      String // "discord", "slack", etc.
  enabled          Boolean                  @default(true)
  config           Json // Extension-specific config (webhookUrl, etc.)
  eventDefinitions ProjectExtensionEvent[]
  lastTriggeredAt  DateTime?
  eventsSentToday  Int                      @default(0)
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  project          Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, extensionId])
  @@index([projectId])
  @@map("project_extension")
}

model ProjectExtensionEvent {
  id                 String            @id @default(cuid())
  projectExtensionId String
  eventDefinitionId  String
  projectExtension   ProjectExtension  @relation(fields: [projectExtensionId], references: [id], onDelete: Cascade)
  eventDefinition    EventDefinition   @relation(fields: [eventDefinitionId], references: [id], onDelete: Cascade)

  @@unique([projectExtensionId, eventDefinitionId])
  @@index([eventDefinitionId])
  @@map("project_extension_event")
}

model ExtensionRateLimit {
  id            String   @id @default(cuid())
  extensionId   String // "discord"
  hourTimestamp DateTime // Truncated to hour
  eventCount    Int      @default(0)

  @@unique([extensionId, hourTimestamp])
  @@index([extensionId, hourTimestamp])
  @@map("extension_rate_limit")
}

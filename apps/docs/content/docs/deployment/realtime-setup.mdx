---
title: Real-Time Setup
description: Enable real-time analytics for your self-hosted Bklit instance
---

# Real-Time Setup (Self-Hosted)

This guide shows you how to enable real-time analytics on your self-hosted Bklit instance using WebSockets.

## Architecture Overview

Bklit uses **WebSockets** for real-time analytics, hosted on **bklit.ws**:

1. **SDK** â†’ Opens WebSocket to `wss://bklit.ws`
2. **WebSocket Server** â†’ Receives events, queues to Redis, broadcasts to dashboards
3. **Worker** â†’ Processes queue, saves to ClickHouse
4. **Dashboard** â†’ Connects to WebSocket for instant updates

**Key Feature:** Sessions end **instantly** (<1 second) when visitors close browser tabs via WebSocket disconnect detection.

## Prerequisites

- A server for WebSocket hosting (we use Hetzner)
- Your Bklit dashboard deployed (Vercel recommended)
- Redis (Upstash recommended, or self-hosted)
- ClickHouse for analytics database

## Infrastructure Setup

### Option 1: Hetzner VPS (Recommended)

**Specifications:**

- **Server:** CCX13 or higher (4 vCPU, 16GB RAM minimum)
- **Cost:** ~$40-80/month
- **Location:** Europe (for GDPR compliance)

**Services to run:**

- WebSocket server (port 8080)
- Worker (background processing)
- ClickHouse (optional - can use managed)

### Option 2: Managed Services

- **WebSocket:** Deploy to any VPS or container platform
- **Redis:** Upstash Redis (generous free tier)
- **ClickHouse:** ClickHouse Cloud or self-hosted
- **Dashboard:** Vercel (serverless)

## DNS Configuration

Point your WebSocket domain to your server:

```
Type: A
Name: @ (for bklit.ws) or ws (for ws.yourdomain.com)
Content: <your-server-ip>
Proxy: DNS only (gray cloud in Cloudflare) âšª IMPORTANT!
TTL: Auto
```

**Critical:** Must use **gray cloud** (DNS only), not orange cloud (proxied). Cloudflare proxy has 100-second timeout on free plan which kills WebSocket connections.

## Server Setup

### 1. Install Dependencies

```bash
# Install Node.js 22+
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
apt-get install -y nodejs

# Install pnpm
npm install -g pnpm

# Clone your repo
git clone https://github.com/yourusername/bklit.git
cd bklit
pnpm install
```

### 2. Configure Environment

Create `.env` file:

```bash
# Redis
REDIS_URL=redis://:<password>@<host>:6379

# ClickHouse
CLICKHOUSE_HOST=<clickhouse-host>
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=<password>
CLICKHOUSE_DATABASE=analytics

# WebSocket
WEBSOCKET_PORT=8080
NODE_ENV=production
```

### 3. Start Services with PM2

```bash
# Install PM2
npm install -g pm2

# Start WebSocket server
pm2 start packages/websocket/src/server.ts --name websocket --interpreter tsx

# Start worker
pm2 start packages/worker/src/index.ts --name worker --interpreter tsx

# Save PM2 config
pm2 save

# Enable auto-start on boot
pm2 startup
```

### 4. Configure Firewall

```bash
# Allow WebSocket port
ufw allow 8080/tcp

# Allow SSH (if not already)
ufw allow 22/tcp

# Enable firewall
ufw enable
```

## SSL/TLS Setup (Production)

For production WebSocket (`wss://`), you need SSL. Use Let's Encrypt:

```bash
# Install Certbot
apt install certbot

# Get certificate
certbot certonly --standalone -d bklit.ws

# Certificate location:
# /etc/letsencrypt/live/bklit.ws/fullchain.pem
# /etc/letsencrypt/live/bklit.ws/privkey.pem
```

Update WebSocket server to use SSL (add to `packages/websocket/src/server.ts`):

```typescript
import { readFileSync } from "fs";
import { createServer } from "https";

const server = createServer({
  cert: readFileSync("/etc/letsencrypt/live/bklit.ws/fullchain.pem"),
  key: readFileSync("/etc/letsencrypt/live/bklit.ws/privkey.pem"),
});

const wss = new WebSocketServer({ server });
server.listen(8080);
```

## Verify It's Working

### 1. Check Services

```bash
pm2 status
```

Should show:

```
websocket  â”‚ online
worker     â”‚ online
```

### 2. Test WebSocket Connection

```bash
curl -i -N --http1.1 \
  -H "Connection: Upgrade" \
  -H "Upgrade: websocket" \
  -H "Sec-WebSocket-Version: 13" \
  -H "Sec-WebSocket-Key: $(openssl rand -base64 16)" \
  http://localhost:8080
```

Should return `101 Switching Protocols`.

### 3. Check Logs

```bash
pm2 logs websocket
pm2 logs worker
```

Look for:

- `[WS] New sdk connection` when a visitor arrives
- `[WS] Pageview received via WebSocket`
- `[Worker] Event processed`

## Dashboard Configuration

Your dashboard on Vercel needs no WebSocket configuration - it connects to `wss://bklit.ws` automatically.

**Environment Variables for Vercel:**

```bash
REDIS_URL=redis://:<password>@<host>:6379
CLICKHOUSE_HOST=<clickhouse-host>
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=<password>
CLICKHOUSE_DATABASE=analytics
DATABASE_URL=<postgres-connection-string>
```

## Monitoring

### Active Connections

```bash
pm2 logs websocket --lines 20
```

Look for connection count in logs.

### Redis Queue Depth

```bash
redis-cli -h <host> -a <password> LLEN analytics:queue
```

Should be 0 or very low (worker processes fast).

### Live Sessions

```bash
redis-cli -h <host> -a <password> ZCARD live:sessions:<project-id>
```

Shows current active WebSocket connections.

## Troubleshooting

**WebSocket won't connect:**

- Check firewall allows port 8080
- Verify DNS is gray cloud (not orange)
- Check SSL certificate if using wss://
- Test with ws:// first, then add SSL

**Sessions not ending:**

- Verify WebSocket server `onclose` handler is working
- Check PM2 logs for disconnect events
- Ensure no proxy is buffering connections

**High latency:**

- Use CDN/edge locations closer to users
- Check Redis latency
- Monitor WebSocket server CPU/memory

## Scaling

### Horizontal Scaling

WebSockets can scale horizontally with Redis Pub/Sub:

1. Run multiple WebSocket servers (different IPs/ports)
2. Use load balancer with sticky sessions
3. Broadcast events via Redis Pub/Sub to all servers
4. Each server broadcasts to its connected clients

### Recommended Stack

For production at scale:

- **WebSocket Servers:** 2-3 instances behind load balancer
- **Redis:** Upstash (managed, auto-scaling)
- **ClickHouse:** ClickHouse Cloud or Hetzner dedicated server
- **Dashboard:** Vercel (edge deployment)
- **Worker:** 1-2 instances (can scale based on queue depth)

## Local Development

```bash
pnpm dev:services  # Docker (Redis, ClickHouse) + WebSocket + Worker
pnpm dev           # Dashboard (Next.js)
```

WebSocket runs on `ws://localhost:8080` automatically in development.

That's it! Your analytics are now real-time with sub-second updates. ðŸš€

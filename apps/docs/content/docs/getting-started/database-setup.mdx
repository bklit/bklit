---
title: Database Setup
description: Set up PostgreSQL and ClickHouse databases for Bklit
---

# Database Setup

Bklit uses two databases:
- **PostgreSQL** - For application data (users, organizations, projects, etc.)
- **ClickHouse** - For analytics data (events, sessions, page views)

## PostgreSQL Setup

### 1. Install PostgreSQL

**macOS (Homebrew):**
```bash
brew install postgresql@15
brew services start postgresql@15
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
```

**Docker:**
```bash
docker run --name bklit-postgres \
  -e POSTGRES_PASSWORD=yourpassword \
  -e POSTGRES_DB=bklit \
  -p 5432:5432 \
  -d postgres:15
```

### 2. Create Database

```bash
# Connect to PostgreSQL
psql -U postgres

# Create database
CREATE DATABASE bklit;

# Create user (optional)
CREATE USER bklit_user WITH PASSWORD 'yourpassword';
GRANT ALL PRIVILEGES ON DATABASE bklit TO bklit_user;

# Exit
\q
```

### 3. Configure Connection String

Add to your `.env` file:

```bash
DATABASE_URL="postgresql://bklit_user:yourpassword@localhost:5432/bklit"
```

### 4. Run Migrations

From the root directory:

```bash
# Generate Prisma client
pnpm db:generate

# Run migrations
pnpm db:migrate
```

This will create all necessary tables in your database.

### 5. (Optional) Open Prisma Studio

View and manage your database:

```bash
pnpm db:studio
```

This opens Prisma Studio at `http://localhost:5555`

## ClickHouse Setup

### 1. Install ClickHouse

**macOS (Homebrew):**
```bash
brew install clickhouse
brew services start clickhouse
```

**Linux:**
```bash
# Add ClickHouse repository
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E0C56BD4
echo "deb https://repo.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
sudo apt-get update
sudo apt-get install -y clickhouse-server clickhouse-client
sudo service clickhouse-server start
```

**Docker:**
```bash
docker run -d \
  --name bklit-clickhouse \
  -p 8123:8123 \
  -p 9000:9000 \
  clickhouse/clickhouse-server
```

### 2. Configure Connection

Add to your `.env` file:

```bash
CLICKHOUSE_HOST="http://localhost:8123"
CLICKHOUSE_USERNAME="default"
CLICKHOUSE_PASSWORD=""
```

For Docker, the default user is `default` with no password.

### 3. Verify Connection

Test the connection:

```bash
# Using ClickHouse client
clickhouse-client

# Or test via HTTP
curl http://localhost:8123
```

## Database Schema

### PostgreSQL Schema

The main tables include:

- **User** - User accounts
- **Organization** - Workspaces/teams
- **Project** - Analytics projects
- **ApiToken** - API authentication tokens
- **Member** - Organization members
- **Invitation** - Pending invitations
- **EventDefinition** - Custom event definitions
- **Funnel** - Conversion funnels

See the [Prisma schema](https://github.com/bklit/bklit/blob/main/packages/db/prisma/schema.prisma) for the complete schema.

### ClickHouse Schema

ClickHouse stores:

- **PageViewEvent** - Page view analytics
- **TrackedEvent** - Custom event analytics
- **TrackedSession** - Session analytics

## Migrations

### Running Migrations

```bash
# Create a new migration
pnpm -F @bklit/db migrate dev --name migration_name

# Apply migrations in production
pnpm db:migrate
```

### Migration Files

Migrations are stored in `packages/db/prisma/migrations/`

Each migration includes:
- SQL statements to modify the schema
- Migration metadata

## Database Management

### Prisma Studio

Visual database browser:

```bash
pnpm db:studio
```

Features:
- Browse tables and data
- Edit records
- Run queries
- View relationships

### Direct Database Access

Connect using your preferred PostgreSQL client:

- **psql** - Command line
- **pgAdmin** - GUI tool
- **TablePlus** - Modern GUI
- **DBeaver** - Universal database tool

## Production Considerations

### Connection Pooling

For production, consider using a connection pooler like PgBouncer:

```bash
DATABASE_URL="postgresql://user:pass@pgbouncer-host:6432/db?pgbouncer=true"
```

### Backups

Set up regular backups:

```bash
# Backup
pg_dump -U user -d bklit > backup.sql

# Restore
psql -U user -d bklit < backup.sql
```

### ClickHouse Clustering

For high availability, set up ClickHouse clusters:

- Use ClickHouse Cloud for managed hosting
- Or configure replication for self-hosted

## Troubleshooting

### Connection Errors

**"Connection refused"**
- Check PostgreSQL/ClickHouse is running
- Verify port numbers (5432 for PostgreSQL, 8123 for ClickHouse)
- Check firewall settings

**"Authentication failed"**
- Verify username and password
- Check user permissions
- Ensure user exists in database

**"Database does not exist"**
- Create the database first
- Check database name in connection string

### Migration Errors

**"Migration failed"**
- Check database connection
- Verify schema conflicts
- Review migration SQL for errors

**"Migration already applied"**
- Check migration history
- Reset if needed (development only): `pnpm -F @bklit/db migrate reset`

## Related Documentation

- [Installation](/docs/getting-started/installation) - Initial setup
- [Environment Variables](/docs/getting-started/environment-variables) - Database connection strings
- [Development](/docs/getting-started/development) - Development workflow

